<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Using D3 to implement Force-directed Graph</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">双轮行</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">HOME</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/project.html">Projects</a></li>
                    <li><a href="/list.html">Posts</a></li>
                    <li><a href="http://wwsun.lofter.com/" target="_blank">Lofter</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>Using D3 to implement Force-directed Graph</h1>
                <p class="post-meta">Oct 8, 2014</p>
            </header>
            <article><p>Force-directed Graph，即力导向图，这种布局模拟了物理学中的力在屏幕上排列元素的机制。力导向图适合用于表现网状数据，也即图数据。图由一组节点(nodes)和连线(edges)构成。节点代表数据集中的实体，连线代表节点之间的关系。这里，我们简单的介绍如何用D3实现这种力导向图。</p>

<!--more-->

<p>从物理角度看， 这种布局表现为粒子之间的互斥作用， 但同时也由弹簧连接。 互斥力会使粒子相互远离， 避免在视觉上重叠， 而弹簧可以防止它们离得太远， 保证我们能在屏幕上看到它们。D3 的力导向布局需要我们分别提供结点和连线， 而且都是对象数组的形式。假设 data.json 文件提供的数据如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"nodes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Root"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Product"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Supplier"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Outsite"</span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nt">"target"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>我们这里的结点（nodes）就是人名， 而连线（edges）则包含两个值：来源（source）ID 和目标（ target）ID。 这些 ID对应着上面的结点， 比如ID为3，表示Outsite。当然，你可以不用索引值，而是直接使用上面的name里的值建立连接关系。</p>

<p>载入数据集可以使用下面的方式。并且，我们将绘制的各个过程也在下面的代码中进行了说明。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>d3.json("data.json", function (dataset) {
	//1.init
	//2.create svg
	//3.create links
	//4.create nodes
	//5.create title
	//6.create listener
	//7.click
}
</code></pre>
</div>

<h4 id="section">1. 初始化：</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>var force = d3.layout.force() //选定force布局
        .nodes(dataset.nodes) //指定节点
        .links(dataset.links) //指定连线
        .size([width,height]) //指定画布大小
        .linkDistance([100])  //连线距离
        .charge([-100])		  //排斥力
        .start();			  //开始
</code></pre>
</div>

<h4 id="svg">2. 创建SVG画布</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>var svg = d3.select("#svgwrapper")	//选中ID为svgwrapper的div元素
    .append("svg")					//添加svg元素
    .attr("width", width)			//指定svg的宽
    .attr("height", height);		//指定svg的高
</code></pre>
</div>

<h4 id="section-1">3. 绘制连线</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>var edges = svg.selectAll("line")
    .data(dataset.links)
    .enter()
    .append("line")
    .style("stroke", "#ccc")		//指定连线的颜色
    .style("stroke-width", 1);		//指定连线的粗细
</code></pre>
</div>

<h4 id="section-2">4. 绘制节点</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>var nodes = svg.selectAll("circle")
    .data(dataset.nodes)
    .enter()
    .append("circle")
    .attr("r", 10)					//指定节点的半径
    .style("fill", "#009966")		//指定节点的颜色
    .call(force.drag);				//允许节点可以拖拽
</code></pre>
</div>

<h4 id="section-3">5. 添加提示信息</h4>
<p>这里，我们允许鼠标悬浮在节点上方的时候显示节点的名称。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>nodes.append("title").text(function (d) {
    return d.name;
});
</code></pre>
</div>

<h4 id="section-4">6. 设置监听器</h4>
<p>这里监听器设置为tick，主要用于监听tick事件以用于更新节点和连接的最新位置。打点（tick）操作的意思大致是使得每次初始化图形的时候，图形可以出现在一个新的位置。官方的解释如下：</p>

<blockquote>
  <p>Runs the force layout simulation one step. This method can be used in conjunction with start and stop to compute a static layout.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>force.on("tick", function() {
	  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

	   node.attr("cx", function(d) { return d.x; })
  	  .attr("cy", function(d) { return d.y; });
});
</code></pre>
</div>

<h4 id="section-5">7. 响应鼠标的点击事件</h4>
<p>这里我们允许浏览器响应用户点击节点的操作，每次点击的时候，我们可以在浏览器控制台中输出一条信息，表明用户点击了哪个点。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>nodes.on("click", function (d) {
    console.log("You clicked " + d.name);
});
</code></pre>
</div>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/force-layout-post.html" data-title="Using D3 to implement Force-directed Graph"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/wwsun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="http://weibo.com/234170023" title="Weibo" class="youtube" target="_blank"><i class="social_icon fa fa-weibo"><span>Weibo</span></i></a></li>
                    <li><a href="https://twitter.com/wsun38" title="Twitter" class="twitter" target="_blank"><i class="social_icon fa fa-twitter"><span>Twitter</span></i></a></li>
                    <li><a href="https://plus.google.com/u/0/101153267739962807712/posts" title="Google+" class="googleplus" target="_blank"><i class="social_icon fa fa-googleplus"><span>GooglePlus</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="http://weibo.com/swwol">Weibo</a></li>
                    <li><a href="https://github.com/wwsun">Github</a></li>
                    <li><a href="http://www.zhihu.com/people/wwsun">Zhihu</a></li>
                    <li><a href="http://www.youtube.com/user/bootstrapbayofficial">Lofter</a></li>
                    <li><a href="http://wwsun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://wwsun.github.io/" title="Sparkling">Weiwei SUN</a> All rights reserved. Theme by 
                <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->

<!-- Google Tag Manager -->
<noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-KJHNXB" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KJHNXB');
</script>
<!-- End Google Tag Manager -->

</body>

</html>