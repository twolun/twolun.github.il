<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>基于MongoDB开发轻量级web应用——以博客为例</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">朱子</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/project.html">项目总结</a></li>
                    <li><a href="/list.html">学习笔记</a></li>
                    <li><a href="/about.html">关于我</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>基于MongoDB开发轻量级web应用——以博客为例</h1>
                <p class="post-meta">Dec 11, 2014</p>
            </header>
            <article><p>本文旨在说明基于MongoDB的web应用开发的基本流程，即如何使用MongoDB来替代传统的关系数据库。对轻量级应用而言，使用MongoDB的最大好处是可以快速的进行数据库设计，无需复杂的模式定义。并且MongoDB易伸缩，文档结构灵活，尤其适合以查询为主的web应用。</p>

<!--more-->

<p>本项目使用Java进行开发，数据库选用的是MongoDB。因为涉及到Java Web的开发，因此选用了两个轻量级的框架，与前端通信的模版框架Freemarker，一个小型MVC框架Spark-java。如果你对这些内容和MongoDB还不了解，可以先阅读<a href="http://wwsun.me/posts/mongodb-1-post.html">这篇文章</a>。</p>

<p>本项目使用Maven作为依赖管理工具。因此需要按照上面的文章配置好依赖。本项目的来源是<code class="highlighter-rouge">MongoDB University</code>的<code class="highlighter-rouge">M101J</code>课程中涉及到的一个小项目，你可以参加<a href="https://university.mongodb.com/">该课程</a>获得详细的MongoDB开发知识。</p>

<h3 id="section">源码获取</h3>
<p>你可以使用git使用下面的指令获得项目的全部代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/wwsun/sun-mongodb-blog
</code></pre>
</div>

<h3 id="section-1">项目组织</h3>
<p>Spark-java内置使用<code class="highlighter-rouge">jetty</code>作为运行容器，因此你无需安装任何web服务器软件。下面介绍具体的开发流程，主要文件如下：</p>

<ul>
  <li>BlogController 控制器文件，充当Mongo工厂、路由配置等功能</li>
  <li>BlogPostDAO\ SessionDAO\ UserDAO 数据访问类，涉及所有的Mongo读写操作</li>
  <li><code class="highlighter-rouge">resources/freemarker/*</code>项目的视图文件</li>
</ul>

<h3 id="section-2">控制器</h3>
<p>使用一个main函数作为启动服务器的入口。main函数可以传递一个string参数作为MongoDB的服务器地址。如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static void main(String[] args) throws IOException {
    if (args.length == 0) {
        new BlogController("mongodb://localhost");
    }
    else {
        new BlogController(args[0]);
    }
}
</code></pre>
</div>

<p>为了简单起见，我们在控制器的构造函数中初始化所有的DAO访问组件、以及建立与Mongo的连接。以下为代码片段，详细的代码请参考你下载下来的源码。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public BlogController(String mongoURIString) throws IOException {
    final MongoClient mongoClient = new MongoClient(new MongoClientURI(mongoURIString));
    final DB blogDatabase = mongoClient.getDB("blog");

    blogPostDAO = new BlogPostDAO(blogDatabase);
    userDAO = new UserDAO(blogDatabase);
    sessionDAO = new SessionDAO(blogDatabase);

    cfg = createFreemarkerConfiguration();
    setPort(8082);
    initializeRoutes();
}
</code></pre>
</div>

<h3 id="section-3">页面路由配置</h3>
<p>这里简单介绍Spark-java的页面路由规则。路由是Spark-java的主要构建模块。一个路由通常由三部分组成：</p>

<ol>
  <li>A verb (get, post, put, delete, head, trace, connect, options)</li>
  <li>A path (/hello, /users/:name)</li>
  <li>A callback (request, response) -&gt; { }</li>
</ol>

<p>下面示范一个简单的路由示例：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>get(new FreemarkerBasedRoute("/", "blog_template.ftl") {
    @Override
    public void doHandle(Request request, Response response, Writer writer) throws IOException, TemplateException {

        SimpleHash root = new SimpleHash();

        root.put("msg", "Hello");
        template.process(root, writer);
    }
});
</code></pre>
</div>

<p>spark-java最新版本按照jdk1.8进行了重构，大量使用了lambda表达式，因此，如果你用的是最新版本的spark-java需要相应的更改路由规则，例如：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// matches "GET /hello/foo" and "GET /hello/bar"
// request.params(":name") is 'foo' or 'bar'
get("/hello/:name", (request, response) -&gt; {
    return "Hello: " + request.params(":name");
});
</code></pre>
</div>

<p>你可以参考Spark-java的<a href="http://sparkjava.com/documentation.html">最新文档</a>获取更多的用法。</p>

<h3 id="dao">DAO</h3>
<p>在DAO涉及到的是所有的数据访问方法。这涉及到MongoDB的Java API的相关知识，你可以参考<a href="http://wwsun.me/posts/mongodb-java-crud-post.html">这篇文章</a>获得MongoDB Java API的相关入门知识。</p>

<p>这里我们提供一个简单的开发示例。例如我们想获取所有的博客文章以显示在主页上，可以使用下面的代码块：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public List&lt;DBObject&gt; findByDateDescending(int limit) {
    List&lt;DBObject&gt; posts;
    DBCursor cursor = postsCollection.find().sort(new BasicDBObject().append("date", -1)).limit(limit);
    try {
        posts = cursor.toArray();
    } finally {
        cursor.close();
    }
    return posts;
}
</code></pre>
</div>

<h3 id="references">References</h3>
<ol>
  <li>http://wwsun.me/posts/mongodb-java-crud-post.html</li>
  <li>https://github.com/wwsun/sun-mongodb-blog</li>
  <li>http://sparkjava.com/documentation.html</li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/mongodb-blog-dev-post.html" data-title="基于MongoDB开发轻量级web应用——以博客为例"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/twolun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="https://github.com/twolun">Github</a></li>
                    <li><a href="http://twolun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://twolun.github.io/" title="Sparkling">朱了</a> All rights reserved. Theme by 
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->



</body>

</html>