<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MongoDB Persistence with Java and Morphia</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">朱子</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/project.html">项目总结</a></li>
                    <li><a href="/list.html">学习笔记</a></li>
                    <li><a href="/about.html">关于我</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>MongoDB Persistence with Java and Morphia</h1>
                <p class="post-meta">Nov 3, 2014</p>
            </header>
            <article><p>本文将介绍MongoDB的Morphia项目，该项目用来提供Java对象与mongodb之间的映射，类似于关系数据库的ORM映射，我们称之为ODM映射，即对象文档映射。Morphia基于注解，支持嵌套文档与对象之间的映射，支持引用、查询更新、运行时验证等。Morphia项目地址为：</p>

<blockquote>
  <p>https://github.com/mongodb/morphia
<!--more--></p>
</blockquote>

<h3 id="morphia">在项目中引入morphia</h3>
<p>我们使用Maven作为构建工具，为了使用morphia，我们需要在Pom中加入如下的依赖，分别为mongodb的java驱动，以及Morphia：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
    &lt;artifactId&gt;mongo-java-driver&lt;/artifactId&gt;
    &lt;version&gt;2.10.1&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.mongodb.morphia&lt;/groupId&gt;
    &lt;artifactId&gt;morphia&lt;/artifactId&gt;
    &lt;version&gt;0.108&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</div>

<p>下面将介绍使用Morphia的基本流程，截取部分代码作为示例，示例程序的完整源代码请查阅[1]。</p>

<h3 id="pojo-with-morphia-annotation">POJO with Morphia Annotation</h3>

<p>如果你想要将一个类的实例通过Morphia存储在Mongo中，首先要做的事实定义POJO类，并使用@Entity注解。默认情况下会将类名存储到文档中，通过设定<code class="highlighter-rouge">noClassnameStored = true</code>来取消该选项。value后面的值表示对应Mongo中的表名。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import org.mongodb.morphia.annotations.Entity;
//...

@Entity (value = "users", noClassnameStored = true)
@Indexes({
        @Index(value = "username, -followers", name="popular"),
        @Index(value ="lastActive", name="idle", expireAfterSeconds = 1000000000)
})
public class GithubUser {

    @Id
    public String userName;
    public String fullName;

    @Property("since")
    public Date memberSince;
    @Reference(lazy = true)
    public List&lt;Repository&gt; repositories = new ArrayList&lt;&gt;();

    public int followers = 0;
    public int following = 0;

    public GithubUser(){
    }

    public GithubUser(final String userName){
        this.userName = userName;
    }
}
</code></pre>
</div>

<ul>
  <li>@id对应于Mongo中的 _id 字段</li>
  <li>@Indexes用于设定索引</li>
  <li>@Embeded 内嵌文档</li>
  <li>@Reference 用于引用数据库中的另一个文档</li>
</ul>

<p>下面说明如何使用@Embeded注解和@Reference注解。</p>

<p>需要注意的是，被Reference的对象必须在引用之前保存，然后才能保存引用该对象的对象。默认情况下Morphia使用字段名作为key值在Mongo中查找对应的Key，你可以使用<code class="highlighter-rouge">@Reference("blog_authors")</code>来自定义搜索的key值。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@Entity("repos")
public class Repository {
    @Id
    public String name;
    @Reference
    public Organization organization;

    @Reference
    public GithubUser owner;
    public Settings settings = new Settings();
	
	//other code
}
</code></pre>
</div>

<p>注意，Embeded类是没有@Id注解的。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@Embedded
public class Settings {
    public String defaultBranch = "master";
    public Boolean allowWiki = false;
    public Boolean alloIssues = true;
}
</code></pre>
</div>

<h3 id="mapping-objects">Mapping Objects</h3>

<p>一旦我们注解好了对象，那么就完成了任务的一半。现在我们需要做的是创建Morphia的实例，说明我们需要映射的类，然后就可以在Java对象和Mongo文档间建立映射关系了。</p>

<p>Datasore是对MongoDB CRUD操作的封装。对每一种操作，你可以指定目标类和具体的参数。Morphia的最新版本（目前最新为0.108）的API地址为：</p>

<blockquote>
  <p>https://rawgit.com/wiki/mongodb/morphia/javadoc/0.108/apidocs/index.html</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>Morphia morphia = new Morphia();
Datastore datastore = morphia.createDatastore(new MongoClient(),"morphia-demo");//初始化数据库名为morphia-demo
morphia.mapPackage("my.package.with.only.mongo.entities");
datastore.ensureIndexes();
</code></pre>
</div>

<p>你可以使用map方法来映射对应的类。另外，也可以用mapPackage来指定要映射的包。Morphia将会自动扫描该包，并映射该包中发现的所有类。关于本部分更详细的内容可以参考:</p>

<blockquote>
  <p>https://github.com/mongodb/morphia/wiki/MappingObjects</p>
</blockquote>

<h3 id="create">Create</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>GithubUser evanchooly = new GithubUser("evanchooly");
evanchooly.fullName = "Justin Lee";
evanchooly.memberSince = date;
evanchooly.following = 1000;

datastore.save(evanchooly);
</code></pre>
</div>

<p>涉及到引用的插入操作，你必须先保存被引用的对象，然后再保存引用其他对象的对象：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Organization org = new Organization("mongodb");
datastore.save(org);

Repository morphia1 = new Repository(org, "morphia");
Repository morphia2 = new Repository(evanchooly, "morphia");

datastore.save(morphia1);
datastore.save(morphia2);

evanchooly.repositories.add(morphia1);
evanchooly.repositories.add(morphia2);

datastore.save(evanchooly);
</code></pre>
</div>

<h3 id="query">Query</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>Query&lt;Repository&gt; query = datastore.createQuery(Repository.class);

Repository repository = query.get();

List&lt;Repository&gt; repositories = query.asList();

Iterable&lt;Repository&gt; fetch = query.fetch();
((MorphiaIterator)fetch).close();

Iterator&lt;Repository&gt; iterator = fetch.iterator();
while(iterator.hasNext()) {
    iterator.next();
}

iterator = fetch.iterator();
while(iterator.hasNext()) {
    iterator.next();
}

query.field("owner").equal(evanchooly).get();

GithubUser memberSince = datastore.createQuery(GithubUser.class).field("memberSince").equal(date).get();
System.out.println("memberSince = " + memberSince);
GithubUser since = datastore.createQuery(GithubUser.class).field("since").equal(date).get();
System.out.println("since = " + since);
</code></pre>
</div>

<h3 id="update">Update</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>evanchooly.followers = 12;
evanchooly.following = 678;
datastore.save(evanchooly);
</code></pre>
</div>

<p>如果需要进行大量的更新可以使用如下方式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>UpdateOperations&lt;GithubUser&gt; update = datastore.createUpdateOperations(GithubUser.class).inc("followers").set("following", 42);
Query&lt;GithubUser&gt; query = datastore.createQuery(GithubUser.class).field("followers").equal(0);
datastore.update(query, update);
</code></pre>
</div>

<h3 id="using-data-access-objects-dao">Using Data Access Objects (DAO)</h3>
<p>一个更好的开发实践是使用DAO来封装调用持久化的过程。Morphia提供了一个抽象的<code class="highlighter-rouge">BasicDAO</code>实现来支持该风格。我们可以使用如下的方式使用DAO：我们需要创建一个DAO类去继承<code class="highlighter-rouge">BasicDAO&lt;T,V&gt;</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import com.mongodb.Mongo;
import org.mongodb.morphia.Morphia;
import org.mongodb.morphia.dao.BasicDAO;
...
public class BlogEntryDAO extends BasicDAO&lt;BlogEntry, ObjectId&gt; {
    public BlogEntryDAO( Morphia morphia, Mongo mongo ) {
        super(mongo, morphia, "myBlogDb");
    }
}
</code></pre>
</div>

<p>DAO已经为我们完成了绝大部分的工作，我们只需要做两件事：</p>

<ol>
  <li>实现构造器，构造器将传递信息给DAO超类。</li>
  <li>实现finder方法。</li>
</ol>

<p>下面我们以持久化和载入博客条目为例进行说明：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>...
BlogEntryDAO blogEntryDAO = new BlogEntryDAO(...);

// get one specific blog entry
ObjectId  blogEntryId = ...;
BlogEntry myBlogEntry = blogEntryDAO.get(blogEntryId);

// update it
myBlogEntry.setTitle("My Blog Entry");
blogEntryDAO.save(myBlogEntry);

// or just delete it
blogEntryDAO.deleteById(myBlogEntry.getId());
...
</code></pre>
</div>

<p>在Web开发中，我们通常使用依赖注入框架（例如Guice或Srping）来将依赖注入到DAO中，然后将DAO注入到控制器中，这样做可以很好的屏蔽各层间的实现细节。</p>

<p>虽然抽象的DAO实现已经有了find()方法，但有时我们需要自定义finder方法来过滤数据，那么我们可以在BlogEntryDAO中加入如下方法：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public List&lt;BlogEntry&gt; findByTitle( String title ) {
    Pattern regExp = Pattern.compile(title + ".*", Pattern.CASE_INSENSITIVE);
    return ds.find(entityClazz).filter("title", regExp).sort("title").asList();
}
</code></pre>
</div>

<h3 id="references">References</h3>

<ol>
  <li>https://github.com/evanchooly/morphia-demo</li>
  <li>https://github.com/mongodb/morphia/wiki/DAOSupport</li>
  <li>https://rawgit.com/wiki/mongodb/morphia/javadoc/0.108/apidocs/index.html</li>
  <li>https://github.com/mongodb/morphia/wiki</li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/mongodb-morphia-post.html" data-title="MongoDB Persistence with Java and Morphia"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/twolun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="https://github.com/twolun">Github</a></li>
                    <li><a href="http://twolun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://twolun.github.io/" title="Sparkling">朱了</a> All rights reserved. Theme by 
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->



</body>

</html>