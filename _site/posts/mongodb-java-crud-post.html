<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Getting Started with Java Driver in MongoDB - CRUD</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">双轮行</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">HOME</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/project.html">Projects</a></li>
                    <li><a href="/list.html">Posts</a></li>
                    <li><a href="http://wwsun.lofter.com/" target="_blank">Lofter</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>Getting Started with Java Driver in MongoDB - CRUD</h1>
                <p class="post-meta">Oct 31, 2014</p>
            </header>
            <article><p>本文将简单介绍MongoDB Java Driver的开发，尤其是CRUD操作。具体的细节信息请阅读其API文档。使用Java driver非常的简单，首先你需要确保导入了 mongo.jar 包，推荐使用Maven作为项目构建工具，这样你可以轻松的管理依赖。其API地址如下：</p>

<blockquote>
  <p>http://api.mongodb.org/</p>

  <!--more-->
</blockquote>

<h3 id="using-maven-to-import-java-driver">Using Maven to import Java Driver</h3>

<p>首先使用在POM中加入MongoDB Java Driver</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;dependency&gt;
   &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
   &lt;artifactId&gt;mongo-java-driver&lt;/artifactId&gt;
   &lt;version&gt;2.10.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</div>

<h3 id="dbobject-and-basicdbobject">DBObject and BasicDBObject</h3>

<p>对应于MongoDB中的文档，在Java Driver中，使用DBObject接口来抽象该文档对象。DBObject类似于Java API中的Map接口，可以使用put方法向对象中加入Key/Value对。基本使用方法如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>BasicDBObject doc = new BasicDBObject();
	        doc.put("userName", "jyemin");
	        doc.put("birthDate", new Date(234832423));
	        doc.put("programmer", true);
	        doc.put("age", 8);
	        doc.put("languages", Arrays.asList("Java", "C++"));
	        doc.put("address", new BasicDBObject("street", "20 Main")
	                .append("town", "Westfield")
	                .append("zip", "56789"));
</code></pre>
</div>

<p>为了便于执行，我们定义一个统一的初始化语句，用于创建到MongoDB的连接：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>private static DBCollection createCollection() throws UnknownHostException {
    MongoClient client = new MongoClient();
    DB db = client.getDB("course");
    DBCollection collection = db.getCollection("TestCollection");
    //collection.drop(); //若存在该集合则删除该集合，重新创建
    return collection;
}
</code></pre>
</div>

<h3 id="insert">Insert</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>DBObject doc = new BasicDBObject().append("x", 1);
//DBObject doc2 = new BasicDBObject().append("x",2);

collection.insert(doc);
collection.insert(doc);//会导致 DuplicateKey 异常
</code></pre>
</div>

<h3 id="find-findone-count">find, findOne, count</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>//findOne
DBObject one = collection.findOne();
	
//findAll
DBCursor cursor = collection.find();
        try {
          while (cursor.hasNext()) {
              DBObject cur = cursor.next();
              System.out.println(cur);
          }
        } finally {
            cursor.close();
        }

//count
long count = collection.count();
</code></pre>
</div>

<h3 id="query-criteria">Query criteria</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>//方法1：传统方法
DBObject query = new BasicDBObject("x",0).append("y", new BasicDBObject("$gt", 10).append("$lt", 90);   //查找所有 x:0, y:10到90之间 的文档，方法1
long count = collection.count(query));   //执行

//方法2：使用QueryBuilder
QueryBuilder builder = QueryBuilder.start("x").is(0)
                .and("y").greaterThan(10).lessThan(70);  //方法2：使用QueryBuilders

long count = collection.count(builder.get());   //执行
</code></pre>
</div>

<h3 id="field-selection">Field Selection</h3>
<div class="highlighter-rouge"><pre class="highlight"><code>DBObject query = QueryBuilder.start("x").is(0)
                .and("y").greaterThan(10).lessThan(70).get(); //查询条件

DBCursor cursor = collection.find(query,
                new BasicDBObject("y", true).append("_id", false)); 
		//参数1：查询条件
		//参数2：字段过滤，只保留y字段
		//因为_id字段默认显示，所以要手动关闭_id字段
		//也可以用 1表示 true，0表示false
</code></pre>
</div>

<h3 id="dot-notation">Dot Notation</h3>

<p>对于内嵌文档，可以直接使用点标记法进行嵌套查询。例如，有如下格式的一批文档：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nt">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nt">"start"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"x"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nt">"y"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">}</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nt">"end"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"x"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nt">"y"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">62</span><span class="p">}}</span><span class="w">
</span></code></pre>
</div>

<p>可以使用如下方式查询</p>

<div class="highlighter-rouge"><pre class="highlight"><code>QueryBuilder builder = QueryBuilder.start("start.x").greaterThan(50);

DBCursor cursor = lines.find(builder.get(),
        new BasicDBObject("start.y", true).append("_id", false)); //查询内部文档

try {
    while (cursor.hasNext()) {
        DBObject cur = cursor.next();
        System.out.println(cur);
    }
} finally {
    cursor.close();
}
</code></pre>
</div>

<h3 id="sort-skip-and-limit">Sort, Skip, and Limit</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>DBCursor cursor = lines.find()
                .sort(new BasicDBObject("start.x", 1).append("start.y", -1)) //排序：start.x升序，start.y降序
                .skip(2).limit(10);  //忽略前2条记录，只显示10条
</code></pre>
</div>

<h3 id="update-and-remove">Update and remove</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>collection.update(new BasicDBObject("_id", "alice"),  //参数1：查询条件
                new BasicDBObject("$set", new BasicDBObject("age", 24))); //参数2：更新内容

collection.update(new BasicDBObject("_id", "frank"),
                new BasicDBObject("$set", new BasicDBObject("age", 24)), true, false);
		//参数1：查询目标
		//参数2：更新操作
		//参数3：是否upsert，即若更新目标不存在，就添加该目标
		//参数4：是否multi，默认只更新第一条匹配项
</code></pre>
</div>

<h3 id="findandmodify">FindAndModify</h3>

<p>默认情况下，返回更新前的查找结果，如果设置 returnNew 为 true的话，则返回更新后的的文档。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public DBObject findAndModify(DBObject query,
                 DBObject fields,
                 DBObject sort,
                 boolean remove,
                 DBObject update,
                 boolean returnNew,
                 boolean upsert)
</code></pre>
</div>

<ul>
  <li>query - specifies the selection criteria for the modification</li>
  <li>fields - a subset of fields to return</li>
  <li>sort - determines which document the operation will modify if the query selects multiple documents</li>
  <li>remove - when true, removes the selected document</li>
  <li>returnNew - when true, returns the modified document rather than the original</li>
  <li>update - the modifications to apply</li>
  <li>upsert - when true, operation creates a new document if the query returns no documents</li>
</ul>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/mongodb-java-crud-post.html" data-title="Getting Started with Java Driver in MongoDB - CRUD"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/wwsun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="http://weibo.com/234170023" title="Weibo" class="youtube" target="_blank"><i class="social_icon fa fa-weibo"><span>Weibo</span></i></a></li>
                    <li><a href="https://twitter.com/wsun38" title="Twitter" class="twitter" target="_blank"><i class="social_icon fa fa-twitter"><span>Twitter</span></i></a></li>
                    <li><a href="https://plus.google.com/u/0/101153267739962807712/posts" title="Google+" class="googleplus" target="_blank"><i class="social_icon fa fa-googleplus"><span>GooglePlus</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="http://weibo.com/swwol">Weibo</a></li>
                    <li><a href="https://github.com/wwsun">Github</a></li>
                    <li><a href="http://www.zhihu.com/people/wwsun">Zhihu</a></li>
                    <li><a href="http://www.youtube.com/user/bootstrapbayofficial">Lofter</a></li>
                    <li><a href="http://wwsun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://wwsun.github.io/" title="Sparkling">Weiwei SUN</a> All rights reserved. Theme by 
                <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->



</body>

</html>