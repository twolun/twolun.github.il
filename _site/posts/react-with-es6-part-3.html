<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>使用ES6编写React应用（3）：React类中方法的绑定</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">双轮行</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">HOME</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/project.html">Projects</a></li>
                    <li><a href="/list.html">Posts</a></li>
                    <li><a href="http://wwsun.lofter.com/" target="_blank">Lofter</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>使用ES6编写React应用（3）：React类中方法的绑定</h1>
                <p class="post-meta">Feb 14, 2016</p>
            </header>
            <article><p>本文是使用ES6来编写React应用系列的第三篇，本文主要将讨论的是React类中方法的绑定问题。
本篇博文的主要目的是解决前一篇文章中的遗留问题。</p>

<!--more-->

<h2 id="statement">Statement</h2>

<ul>
  <li><strong>作者：</strong> <a href="http://wwsun.github.com">景庄</a>，Web开发者，主要关注JavaScript、Node.js、React、Docker等。</li>
  <li><strong>源码：</strong> 本文的源代码地址：https://github.com/wwsun/react-es6-tutorial</li>
</ul>

<h2 id="section">介绍</h2>

<p>如果你阅读并尝试过<a href="http://wwsun.github.io/posts/react-with-es6-part-2.html">前一篇文章</a>中的<strong><code class="highlighter-rouge">CartItem</code>组件的render方法</strong>，
你可能会对其中使用<code class="highlighter-rouge"><span class="p">{</span><span class="err">this.increaseQty.bind(this)</span><span class="p">}</span></code>这样的语句感到困惑。
我们的直觉是直接使用<code class="highlighter-rouge">&lt;button onClick={this.increaseQty} className="button success"&gt;+&lt;/button&gt;</code>这样的代码。
如果你真的尝试这么做了，我们将会在浏览器的控制台中看到这样的一条错误：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Uncaught TypeError: Cannot read property 'setState' of undefined
</code></pre>
</div>

<p>如下图所示：</p>

<p><img src="http://7xpv9g.com1.z0.glb.clouddn.com/imgtype-error.JPG" alt="TypeError" /></p>

<p>这是因为如果我们使用这种方式调用函数的话，此时的<code class="highlighter-rouge">this</code>并没有绑定到类本身，而是<code class="highlighter-rouge">undefined</code>。
这是JavaScript的默认行为。相反，如果你使用<code class="highlighter-rouge">React.createClass()</code>来创建组件的话，
所有的方法都会被自动绑定到对象的实例上。对一些开发者而言，这可能有点反直觉。</p>

<p>之所以没有使用自动绑定，是因为React开发组在决定实现组件对ES6类的支持时决定的。
如果你想了解更详细的原因，你可以通过<a href="http://facebook.github.io/react/blog/2015/01/27/react-v0.13.0-beta-1.html#autobinding">这篇博文</a>了解更多。</p>

<p>下面我们来进一步的讨论，如果你使用的是ES6类的话，如何在JSX中使用不同的方式调用类方法。</p>

<h2 id="functionprototypebind">方法1：使用<code class="highlighter-rouge">Function.prototype.bind()</code></h2>

<p>这也就是我们已经在前一篇博文中使用过的方法：</p>

<p><code class="highlighter-rouge">javascript
class CartItem extends React.Component {
  render() {
    &lt;button onClick={this.increaseQty.bind(this)} className="button success"&gt;+&lt;/button&gt;
  }
}
</code></p>

<p>由于ES6类中的任何一个方法都是普通的JavaScript函数，它从Function原型中继承了<code class="highlighter-rouge">bind()</code>方法。
因此如果我们需要在JSX中调用<code class="highlighter-rouge">increaseQty()</code>，<code class="highlighter-rouge">this</code>将会指向我们的类实例。
你可以从<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">MDN文章</a>中获取更多的有关<code class="highlighter-rouge">Function.prototype.bind()</code>方法的内容。</p>

<h2 id="section-1">方法2：在构造器中使用被定义的函数</h2>

<p>我们还可以通过在类的构造器中解决函数绑定的问题，代码如下：</p>

<p>```javascript
class CartItem extends React.Component {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>constructor(props) {
    super(props);
    this.increaseQty = this.increaseQty.bind(this);
}

render() {
    &lt;button onClick={this.increaseQty} className="button success"&gt;+&lt;/button&gt;
} }
</code></pre>
</div>

<p>```</p>

<p>这样，你就无需在JSX中再使用<code class="highlighter-rouge">bind()</code>方法了，但这种方法的缺点是增加了构造器的代码，并且让构造器不再优美。</p>

<h3 id="section-2">方法3：使用胖箭头函数<code class="highlighter-rouge">=&gt;</code>和构造器</h3>

<p>ES6胖箭头函数会在它们被调用的时候自动保存<code class="highlighter-rouge">this</code>上下文。我们可以通过这个特性来重新构造器中定义<code class="highlighter-rouge">increaseQty()</code>：</p>

<p>```javascript
class CartItem extends React.Component {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>constructor(props) {
    super(props);
    this._increaseQty = () =&gt; this.increaseQty();
}

render() {
    &lt;button onClick={this._increaseQty} className="button success"&gt;+&lt;/button&gt;
} } ```
</code></pre>
</div>

<h3 id="es7">方法4: 组合使用胖箭头函数和ES7类属性（附加）</h3>

<p>首先，要声明一点，这里所谓的ES7只是一种统称，用于指代那些已经处于<code class="highlighter-rouge">stage-0</code>阶段的ES特性。
让我们来看看，ES7的类属性能够带来怎样的代码变化。</p>

<p>```jsx
class CartItem extends React.Component {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>increaseQty = () =&gt; this.increaseQty(); // 相当于直接声明函数表达式

render() {
    return (&lt;button onClick={this.increaseQty} className="button success"&gt;+&lt;/button&gt;);
}
</code></pre>
</div>

<p>}
```</p>

<p>我们发现，我们可以利用类属性来避免在构造器中映入方法的绑定代码。
要想使用上面的代码，你需要在Babel的配置选项中加入<code class="highlighter-rouge">stage-0</code>。</p>

<h3 id="es7-1">方法5: 使用ES7函数绑定语法</h3>

<p>在ES的后续版本中，还会引入一个称为函数绑定操作符<code class="highlighter-rouge">::</code>，事实上，它不过是<code class="highlighter-rouge">Function.propotype.bind()</code>的一种语法糖。
在这里，我们并不深入探讨这个操作符的实现原理，我们只要知道可以如何用在我们的项目中，
幸运的是，Babel已经提供了对这个新语法的支持。</p>

<p>```jsx
class CartItem extends React.Component {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>constructor (props) {
    super(props);
    // this.increaseQty = ::this.increaseQty;  // 类似的，你也可以在这里绑定
}

render () {
    
    return (&lt;button onClick={::this.increaseQty} className="button success"&gt;+&lt;/button&gt;);
} } ```
</code></pre>
</div>

<p>最后，再次声明，所有本文所谓的ES7语法只是建议中的新的语法特性，并不一定会被纳入最终的ES标准中，
在实际的项目开发中需要谨慎使用。</p>

<h2 id="section-3">小结</h2>

<p>在本文中，我们主要讨论几种使用ES6代码来解决绑定到React组件方法的可行方案。
总体而言，由于JavaScript语言的自身特性，我们很难有一个统一的优雅的解决方案，
因此，我更偏向于使用第一种方法，在JSX中进行手动绑定。当然，在未来，ECMAScript标准将有更加优雅的解决方案。
如果你感兴趣的话，可以阅读<a href="http://egorsmirnov.me/2015/08/16/react-and-es6-part3.html">这篇文章</a>。</p>

<h2 id="references">References</h2>

<ol>
  <li><a href="http://facebook.github.io/react/blog/2015/01/27/react-v0.13.0-beta-1.html#autobinding">About autobinding in official React blog</a></li>
  <li><a href="http://www.ian-thomas.net/autobinding-react-and-es6-classes/">Auto binding, React and ES6 Classes</a></li>
  <li><a href="http://babeljs.io/blog/2015/05/14/function-bind/">Function Bind Syntax in Official Babel Blog</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">Function.prototype.bind()</a></li>
  <li>[]()</li>
  <li><a href="https://github.com/zenparsing/es-function-bind">ECMAScript This-Binding Syntax</a></li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/react-with-es6-part-3.html" data-title="使用ES6编写React应用（3）：React类中方法的绑定"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/wwsun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="http://weibo.com/234170023" title="Weibo" class="youtube" target="_blank"><i class="social_icon fa fa-weibo"><span>Weibo</span></i></a></li>
                    <li><a href="https://twitter.com/wsun38" title="Twitter" class="twitter" target="_blank"><i class="social_icon fa fa-twitter"><span>Twitter</span></i></a></li>
                    <li><a href="https://plus.google.com/u/0/101153267739962807712/posts" title="Google+" class="googleplus" target="_blank"><i class="social_icon fa fa-googleplus"><span>GooglePlus</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="http://weibo.com/swwol">Weibo</a></li>
                    <li><a href="https://github.com/wwsun">Github</a></li>
                    <li><a href="http://www.zhihu.com/people/wwsun">Zhihu</a></li>
                    <li><a href="http://www.youtube.com/user/bootstrapbayofficial">Lofter</a></li>
                    <li><a href="http://wwsun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://wwsun.github.io/" title="Sparkling">Weiwei SUN</a> All rights reserved. Theme by 
                <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->

<!-- Google Tag Manager -->
<noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-KJHNXB" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KJHNXB');
</script>
<!-- End Google Tag Manager -->

</body>

</html>