<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>深入浅出Koa（3）：Koa的入门和实现</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">双轮行</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">HOME</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/project.html">Projects</a></li>
                    <li><a href="/list.html">Posts</a></li>
                    <li><a href="http://wwsun.lofter.com/" target="_blank">Lofter</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>深入浅出Koa（3）：Koa的入门和实现</h1>
                <p class="post-meta">Nov 25, 2015</p>
            </header>
            <article><p>前面我们了解Koa的两大基础：生成器和co，Koa是基于这两者之上的新一代的Node中间件框架。
为了能够让你更透彻的理解Koa，本文将要介绍的是Koa的实现。</p>

<!--more-->

<h2 id="koa">Koa入门</h2>

<p>对于Koa而言，你需要知道的并没有很多。如果你阅读了它的源代码的话，你甚至会发现总共才4个文件，每个才300行左右。
Koa遵循了每个程序只做一件事并将其做的更好的原则。你会发现，每个优秀的Koa模块都非常的紧凑，并且只做一件事，
并且在其他模块的基础上进行构建。你应该记住这一点，并使用这个方法来开发你自己的Koa模块。这将会有益于所有人，
也有助于你和其他人阅读源代码。先记住这一点后，然后我们来看看Koa的一些核心特性。</p>

<h3 id="application">应用 Application</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>var koa = require('koa');
var app = koa();
</code></pre>
</div>

<p>创建一个Koa应用只不过是在调用一个相关的模块函数而已。它会提供给你一个对象，这个对象包含一个生成器数组
（一组中间件），对收到的每个请求，它会使用一种堆栈式的方法执行。</p>

<h3 id="cascading">级联 Cascading</h3>

<p>当你使用Koa时，一个非常重要的术语是中间件。现在让我们来搞清楚这个概念。</p>

<blockquote>
  <p>Koa中的中间件是一组用于处理请求的函数。使用Koa创建的服务器，可以有一组堆栈结构的中间件与它关联。</p>
</blockquote>

<p>级联在Koa中意味着：控制流会流经一组中间件。在web开发中这个概念非常的有用，你可以将复杂的行为借助于这个手段变得简单。
Koa通过生成器函数来实现这一点（中间件级联），并且更具创新性和简洁性。
<strong>它能够<code class="highlighter-rouge">yiled</code>下游中间件，之后控制流再返回到上游中间件</strong>。
将生成器加入到控制流中非常简单，只要在调用<code class="highlighter-rouge">use()</code>方法时使用生成器即可。
猜猜下面的代码为什么每次接收到请求时会输出的是<code class="highlighter-rouge">A, B, C, D, E</code>。</p>

<p>下面的代码演示了一个服务器，因此<code class="highlighter-rouge">listen</code>方法用于监听一个具体的端口：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var koa = require('koa');
var app = koa();

// 1
app.use(function *(next) {

	console.log('A');
	yield next;
	console.log('E');

});

// 2
app.use(function *(next) {
	console.log('B');
	yield next;
	console.log('D');
});

// 3
app.use(function *(next) {
	console.log('C');
});

app.listen(3000);
</code></pre>
</div>

<p>当一个新的请求进来的时候，它会流经一系列的中间件（即按照<code class="highlighter-rouge">use</code>方法调用的顺序<code class="highlighter-rouge">1-2-3</code>）。因此在上面的示例代码中，
请求首先经过第一个中间件，它会首先输出<code class="highlighter-rouge">A</code>，然后它遇到了<code class="highlighter-rouge">yield next</code>语句，这会使它转入下一个中间件计算相应的结果，
只有在处理完后才回到离开的地方。因此，接下来会转入到下一个中间件打印<code class="highlighter-rouge">B</code>，再次碰到<code class="highlighter-rouge">yield next</code>，
转入下一个中间件，打印<code class="highlighter-rouge">C</code>。现在已经没有更多的中间件了，因此执行完第三个中间件就会回流，首先回到第二个中间件，
继续执行打印出<code class="highlighter-rouge">D</code>，中间件2的代码执行完毕，再回流到第一个中间件，打印<code class="highlighter-rouge">E</code>。</p>

<p>到目前为止，<code class="highlighter-rouge">Koa</code>模块本身并没有什么复杂的地方，因此没有必要再追溯那些你可以在文档中就能知道的信息。
我推荐你直接去阅读<code class="highlighter-rouge">Koa</code>的文档去了解关于Koa的详细使用说明，其实也没有什么复杂的内容，所以这里也就不再多介绍了。
这里列出相关文档的链接：</p>

<ul>
  <li><a href="http://koajs.com/#context">Context</a></li>
  <li><a href="http://koajs.com/#request">Request</a></li>
  <li><a href="http://koajs.com/#response">Response</a></li>
  <li><a href="http://koajs.com/#settings">其他</a></li>
</ul>

<p>让我们再来看一个例子（这个例子来源于Koa的官网），它利用了一些HTTP特性。第一个中间件计算了响应的时间。
你会发现获取响应开始和结束的时间非常简单。并且在Koa中你可以优雅的将这些功能模块分离开。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>app.use(function *(next) {  
	var start = new Date;
	yield next;
	var ms = new Date - start;
	this.set('X-Response-Time', ms + 'ms');
});

app.use(function *(next) {  
	var start = new Date;
	yield next;
	var ms = new Date - start;
	console.log('%s %s - %s', this.method, this.url, ms);
});

app.use(function *() {  
	this.body = 'Hello World';
});

app.listen(3000);
</code></pre>
</div>

<h2 id="koa-1">Koa的实现</h2>

<p>下面我们来看看koa的源代码，为了简单起见，我们解读的是<code class="highlighter-rouge">v1.x</code>的<a href="https://github.com/koajs/koa/blob/v1.x/lib/application.js">源码</a>。
本部分的内容主要参考了<a href="http://javascript.ruanyifeng.com/nodejs/koa.html">阮一峰的koa介绍</a>的博文。
koa项目的入口文件时<code class="highlighter-rouge">lib/application.js</code>，代码的框架大致如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>function Application() {
	if (!(this instanceof Application)) return new Application;
	this.env = process.env.NODE_ENV || 'development';
	this.subdomainOffset = 2;
	this.middleware = [];
	this.context = Object.create(context);
	this.request = Object.create(request);
	this.response = Object.create(response);
}

var app = Application.prototype;

exports = module.exports = Application;
</code></pre>
</div>

<p><code class="highlighter-rouge">app.use()</code>用于注册中间件，即将生成器函数放入中间件数组：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>app.use = function(fn){
	if (!this.experimental) {
		// es7 async functions are allowed
		assert(fn &amp;&amp; 'GeneratorFunction' == fn.constructor.name, 'app.use() requires a generator function');
	}
	debug('use %s', fn._name || fn.name || '-');
	this.middleware.push(fn);
	return this;
};
</code></pre>
</div>

<p><code class="highlighter-rouge">app.listen()</code>就是将<code class="highlighter-rouge">http.createServer(app.callback()).listen(...)</code>封装了一层：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>app.listen = function(){
	debug('listen');
	var server = http.createServer(this.callback());
	return server.listen.apply(server, arguments);
};

app.callback = function(){
	
	// 将respond函数放入this.middleware
	var mw = [respond].concat(this.middleware); 
	var fn = this.experimental
		? compose_es7(mw)
		: co.wrap(compose(mw)); // 将中间件数组转为一个层层调用的生成器函数
	var self = this;
	
	if (!this.listeners('error').length) this.on('error', this.onerror);
	
	return function(req, res){
		res.statusCode = 404;
		var ctx = self.createContext(req, res);
		onFinished(res, ctx.onerror);
		fn.call(ctx).catch(ctx.onerror);
	}
};
</code></pre>
</div>

<p>在上面的代码中，<code class="highlighter-rouge">app.callback()</code>会返回一个函数，用来处理HTTP请求。它的第一行代码用于将<code class="highlighter-rouge">respond</code>函数放入<code class="highlighter-rouge">this.middleware</code>，
现在<code class="highlighter-rouge">mw</code>数组就包括了<code class="highlighter-rouge">[respond, s1, s2, s3]</code>。</p>

<p><code class="highlighter-rouge">compose(mw)</code>用于将中间件数组转为一个层层调用的生成器函数。我们来看它的源码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>function compose(middleware){
	return function *(next){
		if (!next) next = noop();
	
		var i = middleware.length;
	
		while (i--) {
		next = middleware[i].call(this, next);
		}
	
		yield *next;
	}
}

function *noop(){}
</code></pre>
</div>

<p>在上面的代码中，下一个生成器函数总是上一个生成器函数的参数，从而保证了层层调用。
<code class="highlighter-rouge">var fn = co.wrap(gen)</code>则是将生成器函数包装成自动执行的函数，并且返回一个Promise。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>co.wrap = function (fn) {
	return function () {
		return co.call(this, fn.apply(this, arguments));	
	}	
}
</code></pre>
</div>

<p>将所有的上下文变量都放进<code class="highlighter-rouge">context</code>对象中：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>app.createContext = function(req, res){
	var context = Object.create(this.context);
	var request = context.request = Object.create(this.request);
	var response = context.response = Object.create(this.response);
	context.app = request.app = response.app = this;
	context.req = request.req = response.req = req;
	context.res = request.res = response.res = res;
	request.ctx = response.ctx = context;
	request.response = response;
	response.request = request;
	context.onerror = context.onerror.bind(context);
	context.originalUrl = request.originalUrl = req.url;
	context.cookies = new Cookies(req, res, this.keys);
	context.accept = request.accept = accepts(req);
	context.state = {};
	return context;
};
</code></pre>
</div>

<p>而真正处理HTTP请求的是下面这个生成器函数：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>function *respond(next) {
	yield *next;
	
	// allow bypassing koa
	if (false === this.respond) return;
	
	var res = this.res;
	if (res.headersSent || !this.writable) return;
	
	var body = this.body;
	var code = this.status;
	
	// ignore body
	if (statuses.empty[code]) {
		// strip headers
		this.body = null;
		return res.end();
	}
	
	if ('HEAD' == this.method) {
		if (isJSON(body)) this.length = Buffer.byteLength(JSON.stringify(body));
		return res.end();
	}
	
	// status body
	if (null == body) {
		this.type = 'text';
		body = this.message || String(code);
		this.length = Buffer.byteLength(body);
		return res.end(body);
	}
	
	// responses
	if (Buffer.isBuffer(body)) return res.end(body);
	if ('string' == typeof body) return res.end(body);
	if (body instanceof Stream) return body.pipe(res);
	
	// body: json
	body = JSON.stringify(body);
	this.length = Buffer.byteLength(body);
	res.end(body);
}
</code></pre>
</div>

<h2 id="section">总结</h2>

<p>现在你已经熟悉了Koa的<a href="https://blog.risingstack.com/introduction-to-koa-generators/">核心内容</a>，
虽然使用旧的框架也能够完成相关的任务，但是现在你可以尝试Koa这个新的框架来解决以前的问题。因为，
在旧的框架中可能有非常多的功能是你从来都用不到的，或者某些并不是按照你的设想工作的。
现在，以Koa为代表的现代Node框架能够为你带来这些改变。你可以使用更轻量级的核心，
然后通过npm引入你需要的模块到你的app中，这种方式下你能够完全的控制哪些模块是你需要用的。</p>

<h2 id="references">References</h2>

<ol>
  <li>http://javascript.ruanyifeng.com/nodejs/koa.html</li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/getting-started-with-koa-part-three.html" data-title="深入浅出Koa（3）：Koa的入门和实现"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/wwsun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="http://weibo.com/234170023" title="Weibo" class="youtube" target="_blank"><i class="social_icon fa fa-weibo"><span>Weibo</span></i></a></li>
                    <li><a href="https://twitter.com/wsun38" title="Twitter" class="twitter" target="_blank"><i class="social_icon fa fa-twitter"><span>Twitter</span></i></a></li>
                    <li><a href="https://plus.google.com/u/0/101153267739962807712/posts" title="Google+" class="googleplus" target="_blank"><i class="social_icon fa fa-googleplus"><span>GooglePlus</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="http://weibo.com/swwol">Weibo</a></li>
                    <li><a href="https://github.com/wwsun">Github</a></li>
                    <li><a href="http://www.zhihu.com/people/wwsun">Zhihu</a></li>
                    <li><a href="http://www.youtube.com/user/bootstrapbayofficial">Lofter</a></li>
                    <li><a href="http://wwsun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://wwsun.github.io/" title="Sparkling">Weiwei SUN</a> All rights reserved. Theme by 
                <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->

<!-- Google Tag Manager -->
<noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-KJHNXB" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KJHNXB');
</script>
<!-- End Google Tag Manager -->

</body>

</html>