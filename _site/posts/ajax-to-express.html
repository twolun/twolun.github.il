<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>DOM事件的实时异步传输方法</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">双轮行</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">HOME</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/project.html">Projects</a></li>
                    <li><a href="/list.html">Posts</a></li>
                    <li><a href="http://wwsun.lofter.com/" target="_blank">Lofter</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>DOM事件的实时异步传输方法</h1>
                <p class="post-meta">Jan 9, 2015</p>
            </header>
            <article><p>本文是是基于这样的一个需求，收集用户在页面上的鼠标移动轨迹（或点击事件等信息），将数据实时上传到服务器端。为了完成这样的一个应用，我们使用一个全JavaScript的开发方案。客户端使用jQuery通过Ajax的方式上传获取到的鼠标移动轨迹，通过POST请求发送到服务器端。服务器端基于Node+Express方案，解析POST请求并将数据进行存储。</p>

<!--more-->

<h3 id="section">准备工作</h3>

<ol>
  <li>本项目使用到<code class="highlighter-rouge">Node</code>, <code class="highlighter-rouge">Bower</code>, <code class="highlighter-rouge">Express</code>, <code class="highlighter-rouge">jQuery</code></li>
  <li>使用Express生成项目 <code class="highlighter-rouge">exprss -e demo</code></li>
</ol>

<h3 id="jquery--ajax">使用jQuery + Ajax进行页面数据采集</h3>

<p>在客户端，当用户鼠标在页面上移动时，我们通过其鼠标移动事件<code class="highlighter-rouge">onmousemove</code>捕获其移动的轨迹数据，并将坐标列表通过POST方式上传到服务器端，交由<code class="highlighter-rouge">/upload</code>来处理，<code class="highlighter-rouge">/upload</code>是在服务器端定义的一个路由，该路由中我们将会定义具体的POST处理方式。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var container = document.getElementById('heatmapContainerWrapper');
container.onmousemove = function (e) {
    e.preventDefault();
    $.post('/upload', {
        x: e.layerX,
        y: e.layerY,
        l: document.location.pathname,
        v: 1
    });
};
</code></pre>
</div>

<p>这里我们上传的信息包括鼠标位置的坐标轴X,Y，当前所在的路径（路由），权重（统一设为1）。</p>

<h3 id="express--node">使用Express + Node处理路由请求</h3>

<p>在Node的服务器端，在<code class="highlighter-rouge">app.js</code>中配置需要处理的路由。为了简化起见，我们只将得到的信息打印到服务器端的终端窗口中。合理通过<code class="highlighter-rouge">bodyParser</code>中间件对请求信息进行解析。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>app.post('/upload', function(req, res){
    console.log(JSON.stringify(req.body));
    res.send(req.body);
});
</code></pre>
</div>

<p>通过这样的一个应用，我们可以在开发中完全避免使用其他动态语言编程技术，例如<code class="highlighter-rouge">PHP</code>,<code class="highlighter-rouge">JSP</code>等，就能开发简单的RESTful应用，本文只是整个Heatmap项目的一个组件的开发技巧。</p>

<h3 id="references">References</h3>

<ol>
  <li>http://css-tricks.com/tracking-clicks-building-a-clickmap-with-php-and-jquery/</li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/ajax-to-express.html" data-title="DOM事件的实时异步传输方法"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/wwsun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="http://weibo.com/234170023" title="Weibo" class="youtube" target="_blank"><i class="social_icon fa fa-weibo"><span>Weibo</span></i></a></li>
                    <li><a href="https://twitter.com/wsun38" title="Twitter" class="twitter" target="_blank"><i class="social_icon fa fa-twitter"><span>Twitter</span></i></a></li>
                    <li><a href="https://plus.google.com/u/0/101153267739962807712/posts" title="Google+" class="googleplus" target="_blank"><i class="social_icon fa fa-googleplus"><span>GooglePlus</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="http://weibo.com/swwol">Weibo</a></li>
                    <li><a href="https://github.com/wwsun">Github</a></li>
                    <li><a href="http://www.zhihu.com/people/wwsun">Zhihu</a></li>
                    <li><a href="http://www.youtube.com/user/bootstrapbayofficial">Lofter</a></li>
                    <li><a href="http://wwsun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://wwsun.github.io/" title="Sparkling">Weiwei SUN</a> All rights reserved. Theme by 
                <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->



</body>

</html>