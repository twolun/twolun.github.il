<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>使用Grunt作为JavaScript应用构建工具</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">双轮行</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">HOME</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/project.html">Projects</a></li>
                    <li><a href="/list.html">Posts</a></li>
                    <li><a href="http://wwsun.lofter.com/" target="_blank">Lofter</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>使用Grunt作为JavaScript应用构建工具</h1>
                <p class="post-meta">Oct 4, 2015</p>
            </header>
            <article><p>构建工作主要包括合并静态文件、压缩文件大小、打包应用、编译模块等。为了能够让这些繁杂的任务能够自动进行，
通常我们会借助于构建工具的力量，它能够帮助我们提升效率、节约资源。本文将要介绍了是前端构建工具Grunt，
它具有跨平台的优势，Grunt由Node编写，具有很好的多平台兼容性。</p>

<!--more-->

<h2 id="grunt">Grunt</h2>

<h3 id="section">基础知识</h3>

<p>Grunt是一个基于JavaScript的构建工具。和很多构建工具（<code class="highlighter-rouge">make</code>, <code class="highlighter-rouge">ant</code>）类似，Grunt主要用来自动化你的任务，
诸如代码最小化、代码编译、单元测试、代码规范校验等等重复的任务，你必须要做的工作越少，你的工作就变得越简单，
从而避免重复人工操作中的误操作。Grunt同样依赖于Node，使用NPM进行安装。通过文件<code class="highlighter-rouge">Gruntfile</code>进行配置任务流程，
这样你和你的团队就可以在之后非常简单的执行这些任务。</p>

<p>Grunt主要包括三个部分：</p>

<ul>
  <li>GruntJS CLI 命令行工具</li>
  <li>GruntJS Task Runner 任务运行期</li>
  <li>Grunt Plugins 插件库</li>
</ul>

<h3 id="grunt-1">安装Grunt</h3>

<p>为了能够在任何目录中都能使用grunt，首先你需要全局安装<code class="highlighter-rouge">grunt-cli</code>，它是grunt的命令行工具，
它并不会提供Grunt构建功能，而只是一个Grunt的调用器。
安装完之后，你可以在命令行中直接使用grunt（安装过程可能需要你具备管理员权限）。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install -g grunt-cli
</code></pre>
</div>

<p>这个过程会自动将<code class="highlighter-rouge">grunt</code>加入到你的path环境变量中。需要注意的是，
安装了grunt-cli并不会同时安装grunt。 cli的主要工作就是，当你运行grunt命令时，
CLI载入本地安装的Grunt库，应用<code class="highlighter-rouge">Gruntfile</code>中的配置项，执行你所请求的任务。
你可以通过<a href="https://github.com/gruntjs/grunt-cli/blob/master/bin/grunt">链接页面</a>查看grunt的源代码。</p>

<p>为了在项目中使用grunt，接下来你需要创建项目的<code class="highlighter-rouge">package.json</code>清单文件，该文件用于描述该Node项目。
关于<a href="https://docs.npmjs.com/files/package.json">package.json</a>的更多信息请参考相关文档。
然后将grunt添加到在<code class="highlighter-rouge">package.json</code>文件总的依赖列表中即可。</p>

<p>你需要在项目中安装<code class="highlighter-rouge">grunt</code>依赖，此时不需要全局安装！并且指定<code class="highlighter-rouge">--save-dev</code>，指明其实一个开发阶段的依赖项。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install grunt --save-dev
</code></pre>
</div>

<h3 id="gruntfilejs">创建<code class="highlighter-rouge">Gruntfile.js</code>文件</h3>

<p>最后一步是创建<code class="highlighter-rouge">Gruntfile.js</code>文件，Grunt通过这个文件来载入可用任务以及配置相关参数。
下面的代码展示了一个最简单的<code class="highlighter-rouge">Gruntfile.js</code>文件：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>module.exports = function (grunt) {
	grunt.registerTask('default', []); // 注册一个默认的任务
}
</code></pre>
</div>

<p>值得关注的是，Grunt文件时一个普通的Node模块，遵循CommonJS模块化规范。</p>

<p>在上面的代码中，利用<code class="highlighter-rouge">grunt.registerTask</code>方法创建了一个名为<code class="highlighter-rouge">default</code>的默认任务，
当你在命令行中没有指定具体的任务的时候，默认的任务将会被执行。参数2则是一个任务列表，
你可以指定多个任务。</p>

<p>然后再项目的根目录执行如下命令即可运行grunt：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt
</code></pre>
</div>

<h3 id="grunt-2">设置Grunt任务</h3>

<p>你可以通过安装插件来设置Grunt任务，并在代码中添加配置信息。Grunt插件通常都是作为npm的模块被发布的。
例如JSHint模块，你可以在Grunt中配置JSHint任务。但需要注意的是，你需要安装适用于Grunt的插件，
例如JSHint你需要安装的是<code class="highlighter-rouge">grunt-contrib-jshint</code>。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install --save-dev grunt-contrib-jshint
</code></pre>
</div>

<p>你可以通过<a href="http://gruntjs.com/plugins">Grunt的插件搜索</a>页面来检索你需要的插件。</p>

<p>接下来你要告诉Grunt你会使用的插件，并将其添加到指定的任务队列中，例如加入<code class="highlighter-rouge">default</code>任务队列。
现在<code class="highlighter-rouge">Gruntfile.js</code>的代码如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>module.exports = function (grunt) {
	
	// 配置任务
	grunt.initConfig({
		jshint: ['Gruntfile.js'],
	});
	
	// 每个插件都需要被逐个载入到Grunt中
	grunt.loadNpmTasks('grunt-contrib-jshint');
	
	grunt.registerTask('default', ['jshint']); // 注册一个默认的任务
}
</code></pre>
</div>

<h2 id="grunt-3">使用Grunt来管理构建过程</h2>

<ul>
  <li>Development flow 开发流：Preprocessing, Liniting, Unit testing （关心的是开发效率）</li>
  <li>Release flow 发布流：Compilation, Image spriting, Bunding, Heavy testing, Minification, Perf. tuning （关心的是性能）</li>
  <li>Deployment flow 部署流：关心的是稳定性</li>
</ul>

<p>关于构建你可以参考<a href="http://web.jobbole.com/83690/">这篇文章</a>，这篇文章介绍了绝大部分构建需要考虑到的事情。</p>

<h3 id="lesscss">将less转换成css</h3>

<p>使用<a href="http://lesscss.org/">LESS</a>可以让你的CSS代码遵守DRY原则，LESS的代码更易阅读，因为你可以对代码进行重用，
并且可以在CSS中使用变量。安装LESS插件：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install grunt-contrib-less --save-dev
</code></pre>
</div>

<p>这个插件提供了一个名为<code class="highlighter-rouge">less</code>的任务，你可以在<code class="highlighter-rouge">Gruntfile.js</code>中载入它。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.loadNpmTasks('grunt-contrib-less');
</code></pre>
</div>

<p><code class="highlighter-rouge">less</code>任务的配置对象如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.initConfig({
	less: {
		compile: {
			files: {
				'build/css/compiled.css': 'pubic/css/layout.less'
			}	
		}
	}
})
</code></pre>
</div>

<p>在命令行执行<code class="highlighter-rouge">grunt less</code>即可触发任务。通常推荐你在<code class="highlighter-rouge">grunt</code>后指定运行的目标。因为这里只有<code class="highlighter-rouge">compile</code>目标，
因此这相当于执行<code class="highlighter-rouge">grunt less:compile</code>。如果你不提供目标名，则所有的目标都会被执行。</p>

<h3 id="globbing-patterns">文件名匹配 Globbing patterns</h3>

<p><a href="http://gruntjs.com/configuring-tasks#globbing-patterns">Globbing</a>是一种路径匹配机制，
用于辅助你使用文件路径模式来包含或去除一系列文件。示例如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[
	'public/*.less',
	'public/**/*.less',
	'!public/vendor/**/*.less'
]
</code></pre>
</div>

<ol>
  <li>第一行会匹配public目录下的所有less文件</li>
  <li>第二行会匹配public目录下所有处于子文件夹中的Less文件</li>
  <li><code class="highlighter-rouge">!</code>表示忽略所有匹配的文件</li>
</ol>

<p>理解Globbing模式，你需要知道如下几个匹配符的作用：</p>

<ul>
  <li><code class="highlighter-rouge">*</code> 匹配任意个字符，除了<code class="highlighter-rouge">/</code></li>
  <li><code class="highlighter-rouge">?</code> 匹配单个字符，除了<code class="highlighter-rouge">/</code></li>
  <li><code class="highlighter-rouge">**</code> 匹配任意个字符，包括<code class="highlighter-rouge">/</code></li>
  <li><code class="highlighter-rouge"><span class="p">{}</span></code> 匹配多个选项中的一个，使用逗号分隔</li>
  <li><code class="highlighter-rouge">!</code> 放在模式的最前方，表示忽略匹配符合的项</li>
</ul>

<p>Globbing模式会按照它们所处的先后位置进行匹配。你可以将上面的配置更改为：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>files: {
	'build/css/compiled.css': 'public/css/**/*.less'		
}
</code></pre>
</div>

<h3 id="section-1">打包静态文件</h3>

<p>静态文件打包可以理解为将文件合并起来，这样的话，可以将文件请求减少为单个HTTP响应，从而减少网络的运输开销。
虽然单个文件的载荷可能过大，不过它能够节省客户端的资源开销，避免发起过多的HTTP请求。换句话说，
可以将静态文件打包简单的理解为将多个文件拼接在一起。</p>

<p><img src="/img/posts/151104-static-bundling.png" alt="bundling static assets" /></p>

<p>你可以使用<code class="highlighter-rouge">grunt-contrib-concat</code>插件进行静态资源的合并打包。载入插件，并配置如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.initConfig({
	concat: {
		js: {
			files: {
				'build/js/bundle.js': 'public/js/**/*.js'
			}
		}	
	}
})
</code></pre>
</div>

<p>上面的代码将<code class="highlighter-rouge">public/js</code>下的所有js文件都合并包<code class="highlighter-rouge">bundle.js</code>文件中。</p>

<h3 id="section-2">静态资源最小化</h3>

<p>这个过程包括消除代码中的空格、缩短变量名，优化语法树等操作，从而减小文件的尺寸。并且可以组合服务端的<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/optimize-encoding-and-transfer?hl=en">Gzip</a>压缩，
这个过程后你的源代码文件将被极大的缩小。</p>

<p>文件的打包可以组合文件最小化。两者的目标都是一致的：生成更少、更小的最适合发布的资源包。对于资源最小化而言，
你可以借助<code class="highlighter-rouge">grunt-contrib-uglify</code>插件包来最小化JS源文件。配置如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.initConfig({
	uglify: {
		cobra: {
			files: {
				'build/js/cobra.min.js': 'public/js/cobra.js'
			}	
		}	
	}
})
</code></pre>
</div>

<p>接下来，你可以执行<code class="highlighter-rouge">grunt uglify:cobra</code>来运行该任务。</p>

<p>通常情况下，我们会在执行完打包命令后执行文件最小化操作。我们可以组合这两个任务：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.initConfig({
	uglify: {
		bundle: {
			files: {
				'build/js/bundle.min.js': 'build/js/bundle.js'
			}	
		}	
	}
})
</code></pre>
</div>

<h3 id="sprites">实施图像sprites</h3>

<p>Sprites可以看成是对图像的打包，也就是将多个零散的图片文件组装成单个大文件。不再引用单个文件，
而是通过CSS的<code class="highlighter-rouge">background-position</code>、<code class="highlighter-rouge">width</code>、<code class="highlighter-rouge">height</code>属性来从sprites中选择子图像。</p>

<p>我推荐你使用<code class="highlighter-rouge">grunt-spritesmith</code>插件。它的配置选项如下所示：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.initConfig({
	sprite: {
		icons: {
			src: 'public/img/icons/*.png',
			destImg: 'build/img/icons.png',
			destCSS: 'build/css/icons.png'	
		}	
	}
})
</code></pre>
</div>

<h3 id="section-3">任务别名</h3>

<p>任务的别名用于按顺序组织一组相关的任务，通过任务别名你可以用来组织工作流。在Grunt中，通过如下的方式来定义任务的别名：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.registerTask('js', 'Concatenate and minify js files', ['concat:js', 'uglify:bundle']);
</code></pre>
</div>

<ul>
  <li>参数1：名称</li>
  <li>参数2：描述信息</li>
  <li>参数3：任务列表</li>
</ul>

<h3 id="section-4">清理工作文件夹</h3>

<p>为了达到代码完整性（code integrity），每次重新构建之前首先需要做的是清理工作文件夹，因为你需要确保每次构建后的结果是一致的，
因此最佳实践是在每次构建之前清理掉所有上一次构建后生成的文件。通常我们命名为<code class="highlighter-rouge">build</code>文件夹。</p>

<p>实际发布时，服务器使用的是构建后的文件，而不是源代码文件。还有一点需要再次提醒的是，最佳的做法是，将构建的文件和源代码文件分开。
例如上面提到的<code class="highlighter-rouge">build</code>文件夹放置构建后生成的文件，<code class="highlighter-rouge">src</code>放置源代码文件。</p>

<p>你需要使用<code class="highlighter-rouge">grunt-contrib-clean</code>插件，它提供了一个<code class="highlighter-rouge">clean</code>任务用于帮助你完成清除任务。在任务的配置中，
你需要提供需要清理的目标名，然后再目标名后通过globbing模式指定要清除文件路径。配置如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grunt.initConfig({
	clean: {
		js: 'build/js',
		css: 'build/css',
		less: 'public/**/*.css'
	}		
})
</code></pre>
</div>

<h2 id="section-5">例子</h2>

<p>我们通常会安装两个插件，分别是<code class="highlighter-rouge">load-grunt-tasks</code>[3]和<code class="highlighter-rouge">time-grunt</code>[4]。
第一个插件的作用是用来自动读取package.json文件中的<code class="highlighter-rouge">dependencies/ devDenpendencies/ peerDenpendencies</code>，
从而自动加载与给定模式匹配的Grunt任务。第二个插件的作用是在<code class="highlighter-rouge">console</code>窗口中显示任务的执行状态。</p>

<p>为了示例<code class="highlighter-rouge">Gruntfile.js</code>文件，我们还安装了官方的<code class="highlighter-rouge">grunt-contrib-copy</code>和<code class="highlighter-rouge">grunt-contrib-clean</code>文件用来进行文件的拷贝和清除。
借助这几个插件，我们编写的一个简单的<code class="highlighter-rouge">Gruntfile.js</code>文件如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>'use strict';

module.exports = function (grunt) {
    require('load-grunt-tasks')(grunt);

    require('time-grunt')(grunt);

    var config = {
        app: 'app',
        dist: 'dist'
    };

    grunt.initConfig({
        config: config,
        copy: {
            dist: {
                files: [
                    {
                        expand: true,
                        cwd: '&lt;%= config.app %&gt;/',
                        src: '*.html',
                        dest: '&lt;%= config.dist %&gt;/',
                        ext: '.min.html'
                    }
                ]
            }
        },

        clean: {
            dist: {
                src: ['&lt;%= config.dist %&gt;/**/*'],
                //filter: 'isFile' //only remove file, rather than folder
                filter: function (filepath) {
                    return (!grunt.file.isDir(filepath));
                }
            }
        }
    });
};
</code></pre>
</div>

<p>一个Gruntfile通常由下面几部分组成：</p>

<ul>
  <li>包装函数： <code class="highlighter-rouge">module.exports = function(grunt) { ... }</code></li>
  <li>项目和任务配置: <code class="highlighter-rouge">grunt.initConfig(...)</code></li>
  <li>加载的Grunt插件和任务</li>
  <li>自定义任务</li>
</ul>

<p>实际上，Grunt任务的书写方式可以有很多种，这里我们只是推荐一种最通用的书写方式。我
们在<code class="highlighter-rouge">initConfig</code>中定义了两个task，分别为<code class="highlighter-rouge">copy</code>和<code class="highlighter-rouge">clean</code>。更多的关于task的配置，请参考[2]</p>

<h3 id="grunt-4">Grunt的组件</h3>

<ul>
  <li>任务 task： 通常一个任务需要一个插件来完成某项具体的构建工作</li>
  <li>配置 configuration: 传递给<code class="highlighter-rouge">grunt.initConfig</code>的对象，每个Grunt任务都需要某些配置信息</li>
</ul>

<h2 id="references">References</h2>

<ol>
  <li>http://icodeit.org/2013/10/using-grunt-as-your-build-tool/</li>
  <li>https://github.com/gruntjs/grunt-cli/blob/master/bin/grunt</li>
  <li>http://gruntjs.com/configuring-tasks</li>
  <li>https://github.com/sindresorhus/load-grunt-tasks</li>
  <li>https://github.com/sindresorhus/time-grunt</li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/grunt-getting-started.html" data-title="使用Grunt作为JavaScript应用构建工具"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/wwsun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="http://weibo.com/234170023" title="Weibo" class="youtube" target="_blank"><i class="social_icon fa fa-weibo"><span>Weibo</span></i></a></li>
                    <li><a href="https://twitter.com/wsun38" title="Twitter" class="twitter" target="_blank"><i class="social_icon fa fa-twitter"><span>Twitter</span></i></a></li>
                    <li><a href="https://plus.google.com/u/0/101153267739962807712/posts" title="Google+" class="googleplus" target="_blank"><i class="social_icon fa fa-googleplus"><span>GooglePlus</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="http://weibo.com/swwol">Weibo</a></li>
                    <li><a href="https://github.com/wwsun">Github</a></li>
                    <li><a href="http://www.zhihu.com/people/wwsun">Zhihu</a></li>
                    <li><a href="http://www.youtube.com/user/bootstrapbayofficial">Lofter</a></li>
                    <li><a href="http://wwsun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://wwsun.github.io/" title="Sparkling">Weiwei SUN</a> All rights reserved. Theme by 
                <a href="http://colorlib.com/" target="_blank">Colorlib</a> Powered by
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->



</body>

</html>