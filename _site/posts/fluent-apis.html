<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>如何用JavaScript编写Fluent API</title>
    <meta name="description" content="">
    <!--<link rel="stylesheet" href="/assets/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="/assets/css/font-awesome.min.css">-->
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.useso.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/syntax-highlight.css">
    
    <link rel="stylesheet" href="/assets/css/proj-layout.css">
    <script src="/assets/js/swiftype.js"></script>
    <!--<script src="/assets/js/jquery.js"></script>-->
    <!--<script src="/assets/js/modernizr.min.js"></script>-->
    <!--<script src="/assets/js/bootstrap.min.js"></script>-->
</head>

<body>
    <header>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <p class="site-name"><a class="navbar-brand" href="/" title="twolun">朱子</a></p>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/">首页</a></li>
                    <li><a href="/project.html">项目总结</a></li>
                    <li><a href="/list.html">学习笔记</a></li>
                    <li><a href="/about.html">关于我</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- .site-navigation -->
</header>
    <div id="post-content" class="container">
        <br>
        <div class="well">
            <header class="page-header">
                <h1>如何用JavaScript编写Fluent API</h1>
                <p class="post-meta">May 9, 2015</p>
            </header>
            <article><p>当我们说API是流畅的时候（Fluent API），我们期望别人能够轻松的读懂我们的代码，并且能够很快的在文档的帮助下基于我们的代码进行应用构建。本文将讨论Fluent API，如何考虑，如何设计，以及跨浏览器等。</p>

<!--more-->

<h2 id="fluent-api">什么是Fluent API</h2>

<p>什么是Fluent API，你可以参考这篇<a href="http://www.sitepoint.com/javascript-like-boss-understanding-fluent-apis/">维基百科文章</a>，它是面向对象API的一种实现，目的是提供更加可读的代码。jQuery是这类API的一个典范代表：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$('&lt;div&gt;&lt;/div&gt;')
 .html("Fluent API are cool!")
 .addClass("header")
 .appendTo("body");
</code></pre>
</div>

<p>Fluent API允许你通过返回<code class="highlighter-rouge">this</code>对象的方式将函数链接（Chain）起来。如果你对<code class="highlighter-rouge">this</code>关键字不是很了解，你可以参考<a href="http://www.sitepoint.com/inner-workings-javascripts-this-keyword/">这篇文章</a>。</p>

<h2 id="fluent-api-1">创建一个简单的Fluent API</h2>

<p>我们可以用下面的方式创建一个简单Fluent API：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var MyClass = function(a) {
	this.a = a;
}
 
MyClass.prototype.foo = function(b) {
    // Do some complex work   
    this.a += Math.cos(b);
    return this;
}
</code></pre>
</div>

<p>正如你所看到的，技巧是返回<code class="highlighter-rouge">this</code>对象（其指向当前的实例对象），然后你可以像下面这样使用函数链：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var obj = new MyClass(5);
obj.foo(1).foo(2).foo(3);
</code></pre>
</div>

<h2 id="section">基准测试</h2>

<p>在进一步讨论之前，我们需要考虑这种API设计是否会导致性能问题。因此，我们可以执行以下的benchmark:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// noprotect
var count = 10000000;
 
var MyClass = function(a) {
    this.a = a;
}
 
MyClass.prototype.foo = function(b) {
    // Do some complex work   
    this.a += Math.cos(b);
    return this;
}
 
MyClass.prototype.foo2 = function (b) {
    // Do some complex work   
    this.a += Math.cos(b);
}
 
var start = new Date().getTime();
var obj = new MyClass(5);
obj.foo(1).foo(2).foo(3);
for (var index = 0; index &lt; count; index++) {
    obj.foo(1).foo(2).foo(3);
}
var end = new Date().getTime();
 
var start2 = new Date().getTime();
var obj2 = new MyClass(5);
for (var index = 0; index &lt; count; index++) {
    obj2.foo2(1);
    obj2.foo2(2);
    obj2.foo2(3);
}
var end2 = new Date().getTime();
 
var div = document.getElementById("results");
 
div.innerHTML += obj.a + ": With return this: " + (end - start) + "ms&lt;BR&gt;";
div.innerHTML += obj2.a + ": Without return this: " + (end2 - start2) + "ms";
</code></pre>
</div>

<p>正如你所看到的，<code class="highlighter-rouge">foo</code>和<code class="highlighter-rouge">foo2</code>做了完全相同的事。唯一的区别是，<code class="highlighter-rouge">foo</code>使用了函数链，而<code class="highlighter-rouge">foo2</code>没有使用。在Chrome 42中的运行结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-8658366.13900037: With return this: 1616ms
-8658365.273163341: Without return this: 1639ms
</code></pre>
</div>

<p>显然，在Chrome中使用Fruent API会比普通方式运行效率更高些。 
在上面我们使用了两种不同的调用方式：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>obj.foo(1).foo(2).foo(3);
</code></pre>
</div>

<p>和</p>

<div class="highlighter-rouge"><pre class="highlight"><code>obj2.foo2(1);
obj2.foo2(2);
obj2.foo2(3);
</code></pre>
</div>

<p>在IE和Firefox浏览器中，同样运行上面的代码，我们可以得到如下的结论：</p>

<ul>
  <li>在Firefox中，性能不相上下（仅提高了1%）</li>
  <li>在IE中，Fruent API的性能略低于普通方法（慢了2%左右）</li>
</ul>

<p>另外，对IE平台不同版本的的测试，你可以借助<a href="https://www.modern.ie/">modern.IE这个网站</a>。</p>

<p>从上面我们可以得到结论：Fluent API在提高程序可读性的同时，并不会损失性能，而且在Chrome中，对大型应用而言，还能提升性能。因此，我们朝着我们的目标进发吧——编写Fluent API。</p>

<h2 id="section-1">声明</h2>

<p>本文为译文，原文请访问：http://www.sitepoint.com/javascript-like-boss-understanding-fluent-apis/</p>

<h2 id="references">References</h2>

<ol>
  <li>跨浏览器测试工具 https://www.modern.ie/zh-cn</li>
  <li>免费的开发工具 https://www.visualstudio.com/en-us/products/visual-studio-community-vs</li>
  <li>this关键字解析 http://www.sitepoint.com/inner-workings-javascripts-this-keyword/</li>
  <li>编写更快的JavaScript http://channel9.msdn.com/Series/Practical-Performance-Tips-to-Make-Your-HTMLJavaScript-Faster/06</li>
</ol>
</article>
        </div>
    </div><!--#post-content-->

    <div id="ds-comment" class="container">
        <div class="ds-thread" data-thread-key="/posts/fluent-apis.html" data-title="如何用JavaScript编写Fluent API"></div>
        <script>
            var duoshuoQuery = {short_name:"wwsun"};  
            (function() {  
                var ds = document.createElement('script');  
                ds.type = 'text/javascript';
                ds.async = true;  
                ds.src = 'http://static.duoshuo.com/embed.js';  
                ds.charset = 'UTF-8';  
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);  
            })();
        </script>
    </div><!--#ds-comment-->

    <footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info container">
        <div class="row">
            <nav id="menu-social" class="social-icons">
                <ul id="menu-social-items" class="social-menu">
                    <li><a href="https://github.com/twolun" title="Github" class="rss" target="_blank"><i class="social_icon fa fa-github"><span>Github</span></i></a></li>
                    <li><a href="/about.html#wechatQr" title="Wechat" class="facebook" target="_blank"><i class="fa fa-weixin"><span>Wechat</span></i></a></li>
                </ul>
            </nav>
            <nav role="navigation" class="col-md-6">
                <ul id="menu-flat-footer" class="nav footer-nav clearfix">
                    <li><a href="https://github.com/twolun">Github</a></li>
                    <li><a href="http://twolun.github.io/">Blog</a></li>
                </ul>
            </nav>
            <div class="copyright col-md-6">
                <a href="http://twolun.github.io/" title="Sparkling">朱了</a> All rights reserved. Theme by 
                <a href="https://pages.github.com/" target="_blank">Github Pages</a> and <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>
            </div>
        </div>
    </div>
    <!-- .site-info -->
    <div class="scroll-to-top"><i class="fa fa-angle-up"></i></div>
    <!-- .scroll-to-top -->
</footer><!-- #colophon -->



</body>

</html>